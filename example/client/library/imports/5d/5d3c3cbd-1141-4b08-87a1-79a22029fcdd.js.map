{"version":3,"sources":["assets\\Script\\libs\\starx-wsclient.js"],"names":["Emitter","obj","mixin","key","prototype","on","addEventListener","event","fn","_callbacks","push","once","self","off","apply","arguments","removeListener","removeAllListeners","removeEventListener","length","callbacks","cb","i","splice","emit","args","slice","call","len","listeners","hasListeners","JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","Protocol","window","decodeIO_encoder","decodeIO_decoder","Package","Message","EventEmitter","rsa","sys","localStorage","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","root","starx","socket","reqId","handlers","routeMap","dict","abbrs","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","decode","encode","reconnect","reconncetTimer","reconnectUrl","reconnectAttempts","reconnectionDelay","DEFAULT_MAX_RECONNECT_ATTEMPTS","useCrypto","handshakeBuffer","type","version","initCallback","init","params","host","port","path","byteEncode","byteDecode","url","user","encrypt","generate","data","rsa_n","n","toString","rsa_e","e","connect","defaultDecode","msg","id","route","body","deCompose","defaultEncode","TYPE_REQUEST","TYPE_NOTIFY","lookup","Builder","build","encodeNB","strencode","JSON","stringify","compressRoute","deByteCompose","console","log","maxReconnectAttempts","onopen","reset","TYPE_HANDSHAKE","send","onmessage","processPackage","Date","now","onerror","error","onclose","setTimeout","WebSocket","binaryType","disconnect","close","clearTimeout","request","sendMessage","notify","sig","signString","parse","packet","TYPE_DATA","buffer","handler","heartbeat","TYPE_HEARTBEAT","heartbeatTimeoutCb","gap","handshake","strdecode","code","handshakeInit","TYPE_HANDSHAKE_ACK","onData","processMessage","onKick","TYPE_KICK","msgs","Array","isArray","processMessageBatch","l","initData"],"mappings":"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","sourceRoot":"/","sourcesContent":["(function() {\r\n  function Emitter(obj) {\r\n    if (obj) return mixin(obj);\r\n  }\r\n    /**\r\n   * Mixin the emitter properties.\r\n   *\r\n   * @param {Object} obj\r\n   * @return {Object}\r\n   * @gateway private\r\n   */\r\n\r\n  function mixin(obj) {\r\n    for (var key in Emitter.prototype) {\r\n      obj[key] = Emitter.prototype[key];\r\n    }\r\n    return obj;\r\n  }\r\n\r\n  /**\r\n   * Listen on the given `event` with `fn`.\r\n   *\r\n   * @param {String} event\r\n   * @param {Function} fn\r\n   * @return {Emitter}\r\n   * @gateway public\r\n   */\r\n\r\n  Emitter.prototype.on =\r\n  Emitter.prototype.addEventListener = function(event, fn){\r\n    this._callbacks = this._callbacks || {};\r\n    (this._callbacks[event] = this._callbacks[event] || [])\r\n      .push(fn);\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Adds an `event` listener that will be invoked a single\r\n   * time then automatically removed.\r\n   *\r\n   * @param {String} event\r\n   * @param {Function} fn\r\n   * @return {Emitter}\r\n   * @gateway public\r\n   */\r\n\r\n  Emitter.prototype.once = function(event, fn){\r\n    var self = this;\r\n    this._callbacks = this._callbacks || {};\r\n\r\n    function on() {\r\n      self.off(event, on);\r\n      fn.apply(this, arguments);\r\n    }\r\n\r\n    on.fn = fn;\r\n    this.on(event, on);\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Remove the given callback for `event` or all\r\n   * registered callbacks.\r\n   *\r\n   * @param {String} event\r\n   * @param {Function} fn\r\n   * @return {Emitter}\r\n   * @gateway public\r\n   */\r\n\r\n  Emitter.prototype.off =\r\n  Emitter.prototype.removeListener =\r\n  Emitter.prototype.removeAllListeners =\r\n  Emitter.prototype.removeEventListener = function(event, fn){\r\n    this._callbacks = this._callbacks || {};\r\n\r\n    // all\r\n    if (0 == arguments.length) {\r\n      this._callbacks = {};\r\n      return this;\r\n    }\r\n\r\n    // specific event\r\n    var callbacks = this._callbacks[event];\r\n    if (!callbacks) return this;\r\n\r\n    // remove all handlers\r\n    if (1 == arguments.length) {\r\n      delete this._callbacks[event];\r\n      return this;\r\n    }\r\n\r\n    // remove specific component\r\n    var cb;\r\n    for (var i = 0; i < callbacks.length; i++) {\r\n      cb = callbacks[i];\r\n      if (cb === fn || cb.fn === fn) {\r\n        callbacks.splice(i, 1);\r\n        break;\r\n      }\r\n    }\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Emit `event` with the given args.\r\n   *\r\n   * @param {String} event\r\n   * @param {Mixed} ...\r\n   * @return {Emitter}\r\n   */\r\n\r\n  Emitter.prototype.emit = function(event){\r\n    this._callbacks = this._callbacks || {};\r\n    var args = [].slice.call(arguments, 1)\r\n      , callbacks = this._callbacks[event];\r\n\r\n    if (callbacks) {\r\n      callbacks = callbacks.slice(0);\r\n      for (var i = 0, len = callbacks.length; i < len; ++i) {\r\n        callbacks[i].apply(this, args);\r\n      }\r\n    }\r\n\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Return array of callbacks for `event`.\r\n   *\r\n   * @param {String} event\r\n   * @return {Array}\r\n   * @gateway public\r\n   */\r\n\r\n  Emitter.prototype.listeners = function(event){\r\n    this._callbacks = this._callbacks || {};\r\n    return this._callbacks[event] || [];\r\n  };\r\n\r\n  /**\r\n   * Check if this emitter has `event` handlers.\r\n   *\r\n   * @param {String} event\r\n   * @return {Boolean}\r\n   * @gateway public\r\n   */\r\n\r\n  Emitter.prototype.hasListeners = function(event){\r\n    return !! this.listeners(event).length;\r\n  };\r\n  var JS_WS_CLIENT_TYPE = 'js-websocket';\r\n  var JS_WS_CLIENT_VERSION = '0.0.1';\r\n\r\n  var Protocol = window.Protocol;\r\n  var decodeIO_encoder = null;\r\n  var decodeIO_decoder = null;\r\n  var Package = Protocol.Package;\r\n  var Message = Protocol.Message;\r\n  var EventEmitter = Emitter;\r\n  var rsa = window.rsa;\r\n\r\n  if(typeof(window) != \"undefined\" && typeof(sys) != 'undefined' && sys.localStorage) {\r\n    window.localStorage = sys.localStorage;\r\n  }\r\n\r\n  var RES_OK = 200;\r\n  var RES_FAIL = 500;\r\n  var RES_OLD_CLIENT = 501;\r\n\r\n  if (typeof Object.create !== 'function') {\r\n    Object.create = function (o) {\r\n      function F() {}\r\n      F.prototype = o;\r\n      return new F();\r\n    };\r\n  }\r\n\r\n  var root = window;\r\n  var starx = Object.create(EventEmitter.prototype); // object extend from object\r\n  root.starx = starx;\r\n  var socket = null;\r\n  var reqId = 0;\r\n  var callbacks = {};\r\n  var handlers = {};\r\n  //Map from request id to route\r\n  var routeMap = {};\r\n  var dict = {};    // route string to code\r\n  var abbrs = {};   // code to route string\r\n\r\n  var heartbeatInterval = 0;\r\n  var heartbeatTimeout = 0;\r\n  var nextHeartbeatTimeout = 0;\r\n  var gapThreshold = 100;   // heartbeat gap threashold\r\n  var heartbeatId = null;\r\n  var heartbeatTimeoutId = null;\r\n  var handshakeCallback = null;\r\n\r\n  var decode = null;\r\n  var encode = null;\r\n\r\n  var reconnect = false;\r\n  var reconncetTimer = null;\r\n  var reconnectUrl = null;\r\n  var reconnectAttempts = 0;\r\n  var reconnectionDelay = 5000;\r\n  var DEFAULT_MAX_RECONNECT_ATTEMPTS = 10;\r\n\r\n  var useCrypto;\r\n\r\n  var handshakeBuffer = {\r\n    'sys': {\r\n      type: JS_WS_CLIENT_TYPE,\r\n      version: JS_WS_CLIENT_VERSION,\r\n      rsa: {}\r\n    },\r\n    'user': {\r\n    }\r\n  };\r\n\r\n  var initCallback = null;\r\n\r\n  starx.init = function(params, cb) {\r\n    initCallback = cb;\r\n    var host = params.host;\r\n    var port = params.port;\r\n    var path = params.path;\r\n\r\n    // encode = params.encode || defaultEncode;\r\n    // decode = params.decode || defaultDecode;\r\n    encode = params.encode || byteEncode;\r\n    decode = params.decode || byteDecode;\r\n    var url = 'ws://' + host;\r\n    if(port) {\r\n      url +=  ':' + port;\r\n    }\r\n\r\n    if(path) {\r\n      url += path;\r\n    }\r\n\r\n    handshakeBuffer.user = params.user;\r\n    if(params.encrypt) {\r\n      useCrypto = true;\r\n      rsa.generate(1024, \"10001\");\r\n      var data = {\r\n        rsa_n: rsa.n.toString(16),\r\n        rsa_e: rsa.e\r\n      };\r\n      handshakeBuffer.sys.rsa = data;\r\n    }\r\n    handshakeCallback = params.handshakeCallback;\r\n    connect(params, url, cb);\r\n  };\r\n\r\n  var defaultDecode = starx.decode = function(data) {\r\n    var msg = Message.decode(data);\r\n\r\n    if(msg.id > 0){\r\n      msg.route = routeMap[msg.id];\r\n      delete routeMap[msg.id];\r\n      if(!msg.route){\r\n        return;\r\n      }\r\n    }\r\n\r\n    msg.body = deCompose(msg);\r\n    return msg;\r\n  };\r\n\r\n  var defaultEncode = starx.encode = function(reqId, route, msg) {\r\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\r\n\r\n    if(decodeIO_encoder && decodeIO_encoder.lookup(route)) {\r\n      var Builder = decodeIO_encoder.build(route);\r\n      msg = new Builder(msg).encodeNB();\r\n    } else {\r\n      msg = Protocol.strencode(JSON.stringify(msg));\r\n    }\r\n\r\n    var compressRoute = 0;\r\n    if(dict && dict[route]) {\r\n      route = dict[route];\r\n      compressRoute = 1;\r\n    }\r\n\r\n    return Message.encode(reqId, type, compressRoute, route, msg);\r\n  };\r\n\r\n  //by wolfplus\r\n  var byteDecode = starx.decode = function(data) {\r\n    var msg = Message.decode(data);\r\n\r\n    if(msg.id > 0){\r\n      msg.route = routeMap[msg.id];\r\n      delete routeMap[msg.id];\r\n      if(!msg.route){\r\n        return;\r\n      }\r\n    }\r\n\r\n    msg.body = deByteCompose(msg);\r\n    return msg;\r\n  };\r\n  var byteEncode = starx.encode = function(reqId, route, msg) {\r\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\r\n\r\n    if(decodeIO_encoder && decodeIO_encoder.lookup(route)) {\r\n      var Builder = decodeIO_encoder.build(route);\r\n      msg = new Builder(msg).encodeNB();\r\n    } else {\r\n      //msg = Protocol.strencode(JSON.stringify(msg));\r\n    }\r\n\r\n    var compressRoute = 0;\r\n    if(dict && dict[route]) {\r\n      route = dict[route];\r\n      compressRoute = 1;\r\n    }\r\n\r\n    return Message.encode(reqId, type, compressRoute, route, msg);\r\n  };\r\n  var deByteCompose = function(msg) {\r\n    var route = msg.route;\r\n\r\n    //Decompose route from dict\r\n    if(msg.compressRoute) {\r\n      if(!abbrs[route]){\r\n        return {};\r\n      }\r\n\r\n      route = msg.route = abbrs[route];\r\n    }\r\n\r\n    if(decodeIO_decoder && decodeIO_decoder.lookup(route)) {\r\n      return decodeIO_decoder.build(route).decode(msg.body);\r\n    } else {\r\n      return msg.body;\r\n    }\r\n\r\n    return msg;\r\n  };\r\n\r\n  var connect = function(params, url, cb) {\r\n    console.log('connect to ' + url);\r\n\r\n    var params = params || {};\r\n    var maxReconnectAttempts = params.maxReconnectAttempts || DEFAULT_MAX_RECONNECT_ATTEMPTS;\r\n    reconnectUrl = url;\r\n\r\n    var onopen = function(event) {\r\n      if(!!reconnect) {\r\n        starx.emit('reconnect');\r\n      }\r\n      reset();\r\n      var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\r\n      send(obj);\r\n    };\r\n    var onmessage = function(event) {\r\n      processPackage(Package.decode(event.data), cb);\r\n      // new package arrived, update the heartbeat timeout\r\n      if(heartbeatTimeout) {\r\n        nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\r\n      }\r\n    };\r\n    var onerror = function(event) {\r\n      starx.emit('io-error', event);\r\n      console.error('socket error: ', event);\r\n    };\r\n    var onclose = function(event) {\r\n      starx.emit('close',event);\r\n      starx.emit('disconnect', event);\r\n      console.log('socket close: ', event);\r\n      if(!!params.reconnect && reconnectAttempts < maxReconnectAttempts) {\r\n        reconnect = true;\r\n        reconnectAttempts++;\r\n        reconncetTimer = setTimeout(function() {\r\n          connect(params, reconnectUrl, cb);\r\n        }, reconnectionDelay);\r\n        reconnectionDelay *= 2;\r\n      }\r\n    };\r\n    socket = new WebSocket(url);\r\n    socket.binaryType = 'arraybuffer';\r\n    socket.onopen = onopen;\r\n    socket.onmessage = onmessage;\r\n    socket.onerror = onerror;\r\n    socket.onclose = onclose;\r\n  };\r\n\r\n  starx.disconnect = function() {\r\n    if(socket) {\r\n      if(socket.disconnect) socket.disconnect();\r\n      if(socket.close) socket.close();\r\n      console.log('disconnect');\r\n      socket = null;\r\n    }\r\n\r\n    if(heartbeatId) {\r\n      clearTimeout(heartbeatId);\r\n      heartbeatId = null;\r\n    }\r\n    if(heartbeatTimeoutId) {\r\n      clearTimeout(heartbeatTimeoutId);\r\n      heartbeatTimeoutId = null;\r\n    }\r\n  };\r\n\r\n  var reset = function() {\r\n    reconnect = false;\r\n    reconnectionDelay = 1000 * 5;\r\n    reconnectAttempts = 0;\r\n    clearTimeout(reconncetTimer);\r\n  };\r\n\r\n  starx.request = function(route, msg, cb) {\r\n    if(arguments.length === 2 && typeof msg === 'function') {\r\n      cb = msg;\r\n      msg = {};\r\n    } else {\r\n      msg = msg || {};\r\n    }\r\n    route = route || msg.route;\r\n    if(!route) {\r\n      return;\r\n    }\r\n\r\n    reqId++;\r\n    sendMessage(reqId, route, msg);\r\n\r\n    callbacks[reqId] = cb;\r\n    routeMap[reqId] = route;\r\n  };\r\n\r\n  starx.notify = function(route, msg) {\r\n    msg = msg || {};\r\n    sendMessage(0, route, msg);\r\n  };\r\n\r\n  var sendMessage = function(reqId, route, msg) {\r\n    if(useCrypto) {\r\n      msg = JSON.stringify(msg);\r\n      var sig = rsa.signString(msg, \"sha256\");\r\n      msg = JSON.parse(msg);\r\n      msg['__crypto__'] = sig;\r\n    }\r\n\r\n    if(encode) {\r\n      msg = encode(reqId, route, msg);\r\n    }\r\n\r\n    var packet = Package.encode(Package.TYPE_DATA, msg);\r\n    send(packet);\r\n  };\r\n\r\n  var send = function(packet) {\r\n    socket.send(packet.buffer);\r\n  };\r\n\r\n  var handler = {};\r\n\r\n  var heartbeat = function(data) {\r\n    if(!heartbeatInterval) {\r\n      // no heartbeat\r\n      return;\r\n    }\r\n\r\n    var obj = Package.encode(Package.TYPE_HEARTBEAT);\r\n    if(heartbeatTimeoutId) {\r\n      clearTimeout(heartbeatTimeoutId);\r\n      heartbeatTimeoutId = null;\r\n    }\r\n\r\n    if(heartbeatId) {\r\n      // already in a heartbeat interval\r\n      return;\r\n    }\r\n    heartbeatId = setTimeout(function() {\r\n      heartbeatId = null;\r\n      send(obj);\r\n\r\n      nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\r\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\r\n    }, heartbeatInterval);\r\n  };\r\n\r\n  var heartbeatTimeoutCb = function() {\r\n    var gap = nextHeartbeatTimeout - Date.now();\r\n    if(gap > gapThreshold) {\r\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\r\n    } else {\r\n      console.error('server heartbeat timeout');\r\n      starx.emit('heartbeat timeout');\r\n      starx.disconnect();\r\n    }\r\n  };\r\n\r\n  var handshake = function(data) {\r\n    data = JSON.parse(Protocol.strdecode(data));\r\n    if(data.code === RES_OLD_CLIENT) {\r\n      starx.emit('error', 'client version not fullfill');\r\n      return;\r\n    }\r\n\r\n    if(data.code !== RES_OK) {\r\n      starx.emit('error', 'handshake fail');\r\n      return;\r\n    }\r\n\r\n    handshakeInit(data);\r\n\r\n    var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\r\n    send(obj);\r\n    if(initCallback) {\r\n      initCallback(socket);\r\n    }\r\n  };\r\n\r\n  var onData = function(data) {\r\n    var msg = data;\r\n    if(decode) {\r\n      msg = decode(msg);\r\n    }\r\n    processMessage(starx, msg);\r\n  };\r\n\r\n  var onKick = function(data) {\r\n    data = JSON.parse(Protocol.strdecode(data));\r\n    starx.emit('onKick', data);\r\n  };\r\n\r\n  handlers[Package.TYPE_HANDSHAKE] = handshake;\r\n  handlers[Package.TYPE_HEARTBEAT] = heartbeat;\r\n  handlers[Package.TYPE_DATA] = onData;\r\n  handlers[Package.TYPE_KICK] = onKick;\r\n\r\n  var processPackage = function(msgs) {\r\n    if(Array.isArray(msgs)) {\r\n      for(var i=0; i<msgs.length; i++) {\r\n        var msg = msgs[i];\r\n        handlers[msg.type](msg.body);\r\n      }\r\n    } else {\r\n      handlers[msgs.type](msgs.body);\r\n    }\r\n  };\r\n\r\n  var processMessage = function(starx, msg) {\r\n    if(!msg.id) {\r\n      // server push message\r\n      starx.emit(msg.route, msg.body);\r\n      return;\r\n    }\r\n\r\n    //if have a id then find the callback function with the request\r\n    var cb = callbacks[msg.id];\r\n\r\n    delete callbacks[msg.id];\r\n    if(typeof cb !== 'function') {\r\n      return;\r\n    }\r\n\r\n    cb(msg.body);\r\n\r\n  };\r\n\r\n  var processMessageBatch = function(starx, msgs) {\r\n    for(var i=0, l=msgs.length; i<l; i++) {\r\n      processMessage(starx, msgs[i]);\r\n    }\r\n  };\r\n\r\n  var deCompose = function(msg) {\r\n    var route = msg.route;\r\n\r\n    //Decompose route from dict\r\n    if(msg.compressRoute) {\r\n      if(!abbrs[route]){\r\n        return {};\r\n      }\r\n\r\n      route = msg.route = abbrs[route];\r\n    }\r\n\r\n    if(decodeIO_decoder && decodeIO_decoder.lookup(route)) {\r\n      return decodeIO_decoder.build(route).decode(msg.body);\r\n    } else {\r\n      return JSON.parse(Protocol.strdecode(msg.body));\r\n    }\r\n\r\n    return msg;\r\n  };\r\n\r\n  var handshakeInit = function(data) {\r\n    if(data.sys && data.sys.heartbeat) {\r\n      heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\r\n      heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\r\n    } else {\r\n      heartbeatInterval = 0;\r\n      heartbeatTimeout = 0;\r\n    }\r\n\r\n    initData(data);\r\n\r\n    if(typeof handshakeCallback === 'function') {\r\n      handshakeCallback(data.user);\r\n    }\r\n  };\r\n\r\n  //Initilize data used in starx client\r\n  var initData = function(data) {\r\n    if(!data || !data.sys) {\r\n      return;\r\n    }\r\n    dict = data.sys.dict;\r\n\r\n    //Init compress dict\r\n    if(dict) {\r\n      dict = dict;\r\n      abbrs = {};\r\n\r\n      for(var route in dict) {\r\n        abbrs[dict[route]] = route;\r\n      }\r\n    }\r\n\r\n    window.starx = starx;\r\n  }})();\r\n"]}